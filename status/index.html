<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freegle Docker Status</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .service { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .service.online { background: #d4edda; border-left: 4px solid #28a745; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .service.offline { background: #f8d7da; border-left: 4px solid #dc3545; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .service.loading { background: #fff3cd; border-left: 4px solid #ffc107; position: relative; }
        .status { font-weight: bold; }
        .url { font-family: monospace; color: #666; }
        .logs { font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 3px; max-height: 100px; overflow-y: auto; white-space: pre-wrap; }
        h1 { color: #333; text-align: center; }
        .refresh { text-align: center; margin: 20px 0; }
        .visit-button { background: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .visit-button:hover { background: #0056b3; color: white; }
        .logs-link { color: #007bff; text-decoration: none; font-size: 11px; margin-left: 5px; }
        .logs-link:hover { text-decoration: underline; }
        .cpu-indicator { position: absolute; top: 10px; right: 10px; width: 70px; height: 20px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 2px; overflow: hidden; }
        .cpu-bar { height: 100%; background: #28a745; transition: all 0.3s ease; }
        .cpu-bar.medium { background: #ffc107; }
        .cpu-bar.high { background: #dc3545; }
        .cpu-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 9px; color: #000; font-weight: bold; text-shadow: 0 0 2px rgba(255,255,255,0.8); z-index: 10; white-space: nowrap; }
        .traffic-light { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; border: 3px solid #333; transition: background-color 0.3s ease; }
        .traffic-light.green { background-color: #28a745; box-shadow: 0 0 20px #28a745; }
        .traffic-light.amber { background-color: #ffc107; box-shadow: 0 0 20px #ffc107; }
        .traffic-light.red { background-color: #dc3545; box-shadow: 0 0 20px #dc3545; }
        .action-button { background: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 11px; margin: 2px; cursor: pointer; }
        .action-button:hover { background: #138496; }
        .action-button.danger { background: #dc3545; }
        .action-button.danger:hover { background: #c82333; }
        .action-button:disabled { background: #6c757d; cursor: not-allowed; }
        .container-actions { margin-top: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://www.ilovefreegle.org/icon.png" alt="Freegle Logo" style="height: 60px; margin-bottom: 10px;">
            <div id="trafficLight" class="traffic-light red"></div>
            <h1>Freegle Docker Environment Status</h1>
        </div>
        <div class="refresh">
            <span id="countdown"></span>
        </div>
        
        
        <h2>üè† Freegle Components</h2>
        
        <div id="freegle-dev" class="service loading">
            <div>
                <strong>Freegle Dev (User Site)</strong> - iznik-nuxt3 development<br>
                <span class="url">http://freegle-dev.localhost</span><br>
                <small>Login: test@test.com / freegle</small><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-freegle-dev</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="freegle-prod" class="service loading">
            <div>
                <strong>Freegle Prod (User Site)</strong> - iznik-nuxt3 production<br>
                <span class="url">http://freegle-prod.localhost</span><br>
                <small>Login: test@test.com / freegle</small><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-freegle-prod</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="modtools" class="service loading">
            <div>
                <strong>ModTools (Moderator Site)</strong> - iznik-nuxt3/modtools<br>
                <span class="url">http://modtools.localhost</span><br>
                <small>Login: testmod@test.com / freegle</small><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-modtools</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="apiv1" class="service loading">
            <div>
                <strong>API v1 (Legacy PHP)</strong> - iznik-server<br>
                <span class="url">http://apiv1.localhost</span><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-apiv1</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="apiv2" class="service loading">
            <div>
                <strong>API v2 (Modern Go)</strong> - iznik-server-go<br>
                <span class="url">http://apiv2.localhost:8192</span><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-apiv2</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <h2>üß™ Development Tools</h2>
        
        <div id="phpmyadmin" class="service loading">
            <div>
                <strong>PhpMyAdmin</strong> - Database management<br>
                <span class="url">http://phpmyadmin.localhost</span><br>
                <small>Login: root / iznik</small><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-phpmyadmin</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="mailhog" class="service loading">
            <div>
                <strong>MailHog</strong> - Email testing<br>
                <span class="url">http://mailhog.localhost</span><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-mailhog</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        
        <h2>üîß Infrastructure</h2>
        
        <div id="traefik" class="service loading">
            <div>
                <strong>Traefik</strong> - Reverse proxy<br>
                <span class="url">http://localhost:8080</span><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-traefik</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="tusd" class="service loading">
            <div>
                <strong>TusD</strong> - File upload service<br>
                <span class="url">http://tusd.localhost</span><br>
                <small>Direct access: http://localhost:1080</small><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-tusd</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="percona" class="service loading">
            <div>
                <strong>Percona MySQL</strong> - Primary database<br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-percona</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="postgres" class="service loading">
            <div>
                <strong>PostgreSQL</strong> - PostGIS database<br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-postgres</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="redis" class="service loading">
            <div>
                <strong>Redis</strong> - Cache<br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-redis</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="beanstalkd" class="service loading">
            <div>
                <strong>Beanstalkd</strong> - Job queue<br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-beanstalkd</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="spamassassin" class="service loading">
            <div>
                <strong>SpamAssassin</strong> - Email filtering<br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-spamassassin</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <div id="delivery" class="service loading">
            <div>
                <strong>Image Delivery</strong> - wsrv.nl transformation service<br>
                <span class="url">http://delivery.localhost</span><br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-delivery</small><br>
                <span class="status">Loading...</span>
            </div>
        </div>
        
        <h2>üß™ Testing</h2>
        
        
        <div id="playwright" class="service loading">
            <div>
                <strong>Playwright E2E Tests</strong> - Run automated end-to-end tests against prod<br>
                <small class="container-name" style="color: #999; font-family: monospace;">Container: freegle-playwright</small><br>
                <span class="status">Loading...</span>
                <div class="container-actions" style="margin-top: 8px;">
                    <button id="runTestsBtn" class="action-button" style="background: #0070f3;">Run Tests</button>
                </div>
                <div id="testStatus" style="margin-top: 8px; font-family: monospace; font-size: 12px;"></div>
                <div id="testProgress" style="margin-top: 8px; display: none;">
                    <div id="testProgressText" style="font-size: 12px; color: #333; margin-bottom: 4px; font-weight: bold;"></div>
                    <div id="currentTestName" style="font-size: 11px; color: #666; margin-bottom: 4px; font-style: italic;"></div>
                </div>
                <div id="testLogs" class="logs" style="display: none; max-height: 200px;"></div>
                <div style="margin-top: 8px;">
                    <button id="toggleLogsBtn" class="action-button" style="background: #6c757d; font-size: 10px; margin-right: 4px; display: none;">Show/Hide Logs</button>
                    <a id="reportLinkBtn" href="http://localhost:9323" target="_blank" class="action-button" style="background: #17a2b8; font-size: 10px; text-decoration: none;">HTML Report</a>
                </div>
            </div>
        </div>
        
        <!-- Full-width progress bar outside the service container -->
        <div id="fullWidthProgress" style="display: none; margin: 10px 0; position: sticky; top: 10px; z-index: 1000;">
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; height: 24px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div id="testProgressBar" style="background: linear-gradient(90deg, #0070f3, #0056b3); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center;">
                    <span id="progressBarText" style="color: white; font-weight: bold; font-size: 12px; margin-left: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let countdownSeconds = 10;
        
        function updateCountdown() {
            document.getElementById('countdown').textContent = `Next check in ${countdownSeconds} seconds`;
            if (countdownSeconds > 0) {
                countdownSeconds--;
            }
        }
        
        const services = [
            { id: 'freegle-dev', container: 'freegle-freegle-dev' },
            { id: 'freegle-prod', container: 'freegle-freegle-prod' },
            { id: 'modtools', container: 'freegle-modtools' },
            { id: 'apiv1', container: 'freegle-apiv1' },
            { id: 'apiv2', container: 'freegle-apiv2' },
            { id: 'phpmyadmin', container: 'freegle-phpmyadmin' },
            { id: 'mailhog', container: 'freegle-mailhog' },
            { id: 'playwright', container: 'freegle-playwright' },
            { id: 'percona', container: 'freegle-percona' },
            { id: 'postgres', container: 'freegle-postgres' },
            { id: 'redis', container: 'freegle-redis' },
            { id: 'beanstalkd', container: 'freegle-beanstalkd' },
            { id: 'spamassassin', container: 'freegle-spamassassin' },
            { id: 'traefik', container: 'freegle-traefik' },
            { id: 'tusd', container: 'freegle-tusd' },
            { id: 'delivery', container: 'freegle-delivery' }
        ];

        function addActionButtons(service, element) {
            // Add visit button for web services
            if (service.id === 'freegle-dev' || service.id === 'freegle-prod' || service.id === 'modtools') {
                const serviceUrl = service.id === 'freegle-dev' ? 'http://freegle-dev.localhost' : 
                                 service.id === 'freegle-prod' ? 'http://freegle-prod.localhost' : 
                                 'http://modtools.localhost';
                const serviceName = service.id === 'freegle-dev' ? 'Freegle Dev' : 
                                  service.id === 'freegle-prod' ? 'Freegle Prod' : 
                                  'ModTools';
                
                if (!element.querySelector('.visit-button')) {
                    const visitButton = document.createElement('a');
                    visitButton.href = serviceUrl;
                    visitButton.target = '_blank';
                    visitButton.className = 'visit-button';
                    visitButton.textContent = `Visit ${serviceName}`;
                    visitButton.style.position = 'absolute';
                    visitButton.style.right = '10px';
                    visitButton.style.bottom = '10px';
                    visitButton.style.zIndex = '1000';
                    element.appendChild(visitButton);
                }
            } else if (service.id === 'phpmyadmin' || service.id === 'mailhog') {
                const serviceUrl = service.id === 'phpmyadmin' ? 'http://phpmyadmin.localhost' : 'http://mailhog.localhost';
                const serviceName = service.id === 'phpmyadmin' ? 'PhpMyAdmin' : 'MailHog';
                
                if (!element.querySelector('.visit-button')) {
                    const visitButton = document.createElement('a');
                    visitButton.href = serviceUrl;
                    visitButton.target = '_blank';
                    visitButton.className = 'visit-button';
                    visitButton.textContent = `Visit ${serviceName}`;
                    visitButton.style.position = 'absolute';
                    visitButton.style.right = '10px';
                    visitButton.style.bottom = '10px';
                    visitButton.style.zIndex = '1000';
                    element.appendChild(visitButton);
                }
            }
            
            // Add logs link next to container name
            const containerLine = element.querySelector('.container-name');
            if (containerLine && !containerLine.querySelector('.logs-link')) {
                const logsLink = document.createElement('a');
                logsLink.href = `/logs.html?container=${service.container}`;
                logsLink.target = '_blank';
                logsLink.className = 'logs-link';
                logsLink.textContent = 'logs';
                containerLine.appendChild(logsLink);
            }
            
            // Add container action buttons
            let actionsDiv = element.querySelector('.container-actions');
            if (!actionsDiv) {
                actionsDiv = document.createElement('div');
                actionsDiv.className = 'container-actions';
                element.appendChild(actionsDiv);
            }
            
            // Only add buttons if they don't already exist
            if (!actionsDiv.querySelector('.restart-btn')) {
                // Restart button
                const restartBtn = document.createElement('button');
                restartBtn.className = 'action-button restart-btn';
                restartBtn.textContent = 'Restart';
                restartBtn.onclick = () => restartContainer(service.container);
                actionsDiv.appendChild(restartBtn);
            }
            
            // Rebuild button (for containers that can be rebuilt - those with build context)
            if (['freegle-dev', 'freegle-prod', 'modtools', 'apiv1', 'apiv2', 'playwright', 'status'].includes(service.id)) {
                if (!actionsDiv.querySelector('.rebuild-btn')) {
                    const rebuildBtn = document.createElement('button');
                    rebuildBtn.className = 'action-button danger rebuild-btn';
                    rebuildBtn.textContent = 'Rebuild';
                    rebuildBtn.onclick = () => rebuildContainer(service.container, service.id);
                    actionsDiv.appendChild(rebuildBtn);
                }
            }
        }

        function updateServiceDisplay(service, data) {
            const element = document.getElementById(service.id);
            if (!element) return;
            
            const statusElement = element.querySelector('.status');
            addActionButtons(service, element);
            
            // Format start time and uptime
            let timeInfo = '';
            if (data.startTime && data.uptime !== null) {
                const startTime = new Date(data.startTime);
                const uptimeStr = formatUptime(data.uptime);
                timeInfo = `<br><small style="font-weight: normal; color: #999; font-size: 10px;">Started: ${formatDateTime(startTime)} (${uptimeStr})</small>`;
            }
            
            if (data.status === 'success') {
                statusElement.innerHTML = `Running<br><small style="font-weight: normal; color: #666;">‚úì ${data.message}</small>${timeInfo}`;
                element.className = 'service online';
            } else if (data.status === 'starting') {
                statusElement.innerHTML = `Starting...<br><small style="font-weight: normal; color: #666;">${data.message}</small>${timeInfo}`;
                element.className = 'service loading';
            } else {
                statusElement.innerHTML = `Offline<br><small style="font-weight: normal; color: #666;">${data.message}</small>${timeInfo}`;
                element.className = 'service offline';
            }
            
            // Update CPU indicator for all running containers (including building ones)
            if (data.cpu !== undefined && data.cpu > 0) {
                let cpuIndicator = element.querySelector('.cpu-indicator');
                if (!cpuIndicator) {
                    cpuIndicator = document.createElement('div');
                    cpuIndicator.className = 'cpu-indicator';
                    element.appendChild(cpuIndicator);
                }
                
                const cpu = Math.round(data.cpu || 0);
                cpuIndicator.innerHTML = `
                    <div class="cpu-bar ${cpu > 80 ? 'high' : cpu > 50 ? 'medium' : ''}" style="width: ${cpu}%;"></div>
                    <div class="cpu-text">CPU ${cpu}%</div>
                `;
            }
            
            // Test button is always enabled since dependencies are handled by Docker Compose
        }


        async function restartContainer(containerName) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Restarting...';
            
            try {
                const response = await fetch('/api/container/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ container: containerName })
                });
                
                const result = await response.text();
                if (response.ok) {
                    button.textContent = 'Restarted!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 3000);
                } else {
                    alert(`Failed to restart: ${result}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        async function rebuildContainer(containerName, serviceName) {
            if (!confirm(`Are you sure you want to rebuild ${serviceName}? This will take several minutes.`)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Rebuilding...';
            
            try {
                const response = await fetch('/api/container/rebuild', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ container: containerName, service: serviceName })
                });
                
                const result = await response.text();
                if (response.ok) {
                    button.textContent = 'Rebuilt!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 5000);
                } else {
                    alert(`Failed to rebuild: ${result}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function checkAllServices() {
            try {
                const response = await fetch('/api/status/all');
                if (response.ok) {
                    const allStatus = await response.json();
                    
                    // Update all services from cached data
                    for (const service of services) {
                        const data = allStatus[service.id];
                        if (data) {
                            updateServiceDisplay(service, data);
                        }
                    }
                    
                    // Update traffic light
                    const allOnline = services.every(service => {
                        const element = document.getElementById(service.id);
                        return element && element.className.includes('online');
                    });
                    
                    const trafficLight = document.getElementById('trafficLight');
                    if (allOnline) {
                        trafficLight.className = 'traffic-light green';
                    } else {
                        trafficLight.className = 'traffic-light amber';
                    }
                }
            } catch (error) {
                console.error('Failed to get status data:', error);
            }
            
            // Reset countdown
            countdownSeconds = 10;
        }

        async function runPlaywrightTests() {
            console.log('runPlaywrightTests called');
            const button = document.getElementById('runTestsBtn');
            const statusDiv = document.getElementById('testStatus');
            const logsDiv = document.getElementById('testLogs');
            const progressDiv = document.getElementById('testProgress');
            const toggleLogsBtn = document.getElementById('toggleLogsBtn');
            
            // Dependencies are handled by Docker Compose, so tests can run immediately
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Starting Tests...';
            statusDiv.innerHTML = '<span style="color: #0070f3;">‚ñ∂ Initializing test environment...</span>';
            logsDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            toggleLogsBtn.style.display = 'none';
            updateProgress(0, 'Starting...');
            
            try {
                console.log('Making API request to /api/tests/playwright');
                const response = await fetch('/api/tests/playwright', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    button.textContent = 'Tests Running...';
                    statusDiv.innerHTML = '<span style="color: #0070f3;">üß™ Tests are running in Docker container...</span>';
                    updateProgress(10, 'Test environment starting...');
                    
                    // Start polling for test results
                    console.log('Starting test result polling');
                    pollTestResults();
                } else {
                    const error = await response.text();
                    console.error('API error response:', error);
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Failed to start tests: ${error}</span>`;
                    resetTestUI(originalText);
                }
            } catch (error) {
                console.error('Test start error:', error);
                statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error: ${error.message}</span>`;
                resetTestUI(originalText);
            }
        }

        function updateProgress(percentage, text, currentTest = null) {
            const progressBar = document.getElementById('testProgressBar');
            const progressText = document.getElementById('testProgressText');
            const progressBarText = document.getElementById('progressBarText');
            const currentTestName = document.getElementById('currentTestName');
            const fullWidthProgress = document.getElementById('fullWidthProgress');
            
            // Update both progress bars
            progressBar.style.width = percentage + '%';
            progressText.textContent = text;
            progressBarText.textContent = `${percentage}%`;
            
            // Show/hide full width progress bar based on test status
            if (percentage > 0 && document.getElementById('runTestsBtn').disabled) {
                fullWidthProgress.style.display = 'block';
            } else {
                fullWidthProgress.style.display = 'none';
            }
            
            // Update current test name
            if (currentTest && currentTest.title) {
                currentTestName.textContent = `Currently running: ${currentTest.title}`;
                currentTestName.style.display = 'block';
            } else {
                currentTestName.style.display = 'none';
            }
        }

        function resetTestUI(buttonText) {
            const button = document.getElementById('runTestsBtn');
            const progressDiv = document.getElementById('testProgress');
            const toggleLogsBtn = document.getElementById('toggleLogsBtn');
            const fullWidthProgress = document.getElementById('fullWidthProgress');
            
            button.textContent = buttonText;
            button.disabled = false;
            progressDiv.style.display = 'none';
            fullWidthProgress.style.display = 'none';
            toggleLogsBtn.style.display = 'inline-block';
        }
        
        async function pollTestResults() {
            console.log('Polling test results...');
            const statusDiv = document.getElementById('testStatus');
            const logsDiv = document.getElementById('testLogs');
            
            try {
                const response = await fetch('/api/tests/playwright/status');
                console.log('Poll response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Poll result:', result.status, result.message);
                    
                    if (result.status === 'running') {
                        statusDiv.innerHTML = `<span style="color: #0070f3;">üß™ Tests running...</span>`;
                        
                        // Update progress based on log content
                        const progress = estimateProgressFromLogs(result.logs, result);
                        updateProgress(progress.percentage, progress.text, result.currentRunningTest);
                        
                        // Update logs
                        if (result.logs) {
                            logsDiv.textContent = result.logs;
                        }
                        
                        // Continue polling
                        console.log('Continuing to poll in 2 seconds...');
                        setTimeout(pollTestResults, 2000);
                    } else if (result.status === 'completed') {
                        const color = result.success ? '#28a745' : '#dc3545';
                        const icon = result.success ? '‚úÖ' : '‚ùå';
                        statusDiv.innerHTML = `<span style="color: ${color};">${icon} ${result.message}</span>`;
                        updateProgress(100, result.success ? 'All tests passed!' : 'Tests completed with failures');
                        
                        if (result.logs) {
                            logsDiv.textContent = result.logs;
                        }
                        console.log('Tests completed, stopping polling');
                        resetTestUI('Run Playwright Tests');
                    } else if (result.status === 'failed') {
                        statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${result.message}</span>`;
                        updateProgress(0, 'Test execution failed');
                        
                        if (result.logs) {
                            logsDiv.textContent = result.logs;
                        }
                        console.log('Tests failed, stopping polling');
                        resetTestUI('Run Playwright Tests');
                    } else if (result.status === 'idle') {
                        console.log('Tests are idle, stopping polling');
                        resetTestUI('Run Playwright Tests');
                    }
                } else {
                    // If status check fails, assume tests are done
                    console.error('Status check failed with:', response.status);
                    statusDiv.innerHTML = '<span style="color: #6c757d;">‚ùì Test status unknown</span>';
                    resetTestUI('Run Playwright Tests');
                }
            } catch (error) {
                console.error('Error polling test results:', error);
                statusDiv.innerHTML = '<span style="color: #6c757d;">‚ùì Unable to check test status</span>';
                resetTestUI('Run Playwright Tests');
            }
        }

        function estimateProgressFromLogs(logs, result) {
            if (!logs) return { percentage: 5, text: 'Starting...' };
            
            const lowerLogs = logs.toLowerCase();
            
            // Use server-provided test progress data if available
            if (result && result.completedTests !== undefined && result.totalTests !== undefined) {
                const completed = result.completedTests;
                const total = result.totalTests;
                // Simple percentage calculation: completed/total * 100
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                return { percentage: Math.min(100, percentage), text: `${completed}/${total} tests completed` };
            }
            
            // More granular progress tracking
            if (lowerLogs.includes('checking package.json')) {
                return { percentage: 10, text: 'Initializing environment...' };
            } else if (lowerLogs.includes('installing dependencies')) {
                return { percentage: 25, text: 'Installing dependencies...' };
            } else if (lowerLogs.includes('installing playwright')) {
                return { percentage: 45, text: 'Installing Playwright browsers...' };
            } else if (lowerLogs.includes('running playwright') || lowerLogs.includes('running') && lowerLogs.includes('tests')) {
                // Fallback progress estimation from logs
                const testMatch = logs.match(/(\d+)\/(\d+) tests completed/i);
                const runningMatch = logs.match(/running (\d+) tests?/i);
                
                if (testMatch) {
                    const completed = parseInt(testMatch[1]);
                    const total = parseInt(testMatch[2]);
                    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                    return { percentage: Math.min(100, percentage), text: `${completed}/${total} tests completed` };
                } else if (runningMatch) {
                    return { percentage: 65, text: `Running ${runningMatch[1]} tests...` };
                }
                return { percentage: 65, text: 'Running tests...' };
            } else if (lowerLogs.includes('passed') && lowerLogs.includes('failed')) {
                // Extract test summary
                const passedMatch = logs.match(/(\d+) passed/i);
                const failedMatch = logs.match(/(\d+) failed/i);
                if (passedMatch || failedMatch) {
                    const passed = passedMatch ? passedMatch[1] : '0';
                    const failed = failedMatch ? failedMatch[1] : '0';
                    return { percentage: 85, text: `${passed} passed, ${failed} failed` };
                }
                return { percentage: 85, text: 'Processing results...' };
            } else if (lowerLogs.includes('generating reports')) {
                return { percentage: 90, text: 'Generating reports...' };
            } else if (lowerLogs.includes('test results')) {
                return { percentage: 80, text: 'Processing results...' };
            } else if (lowerLogs.includes('cleaned up') || lowerLogs.includes('freegle container is running')) {
                return { percentage: 15, text: 'Environment ready...' };
            } else {
                return { percentage: 35, text: 'Test environment working...' };
            }
        }

        function toggleLogs() {
            const logsDiv = document.getElementById('testLogs');
            logsDiv.style.display = logsDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Helper functions for formatting times
        function formatDateTime(date) {
            if (!date) return 'Unknown';
            const now = new Date();
            const diffMs = now - date;
            const diffHours = diffMs / (1000 * 60 * 60);
            
            if (diffHours < 24) {
                // Show time if less than 24 hours ago
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            } else {
                // Show date and time if more than 24 hours ago
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }
        }
        
        function formatUptime(seconds) {
            if (seconds === null || seconds < 0) return 'Unknown';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }


        // Check for existing test status on page load
        async function checkInitialTestStatus() {
            console.log('Checking for existing test status...');
            try {
                const response = await fetch('/api/tests/playwright/status');
                if (response.ok) {
                    const result = await response.json();
                    console.log('Initial test status:', result.status);
                    
                    if (result.status === 'running') {
                        console.log('Found running tests, starting UI polling');
                        const button = document.getElementById('runTestsBtn');
                        const statusDiv = document.getElementById('testStatus');
                        const progressDiv = document.getElementById('testProgress');
                        
                        // Update UI to show tests are running
                        button.disabled = true;
                        button.textContent = 'Tests Running...';
                        statusDiv.innerHTML = `<span style="color: #0070f3;">üß™ ${result.message || 'Tests in progress...'}</span>`;
                        progressDiv.style.display = 'block';
                        
                        // Update progress based on current status
                        const progress = estimateProgressFromLogs(result.logs, result);
                        updateProgress(progress.percentage, progress.text, result.currentRunningTest);
                        
                        // Update logs if available
                        const logsDiv = document.getElementById('testLogs');
                        if (result.logs) {
                            logsDiv.textContent = result.logs;
                        }
                        
                        // Start polling
                        setTimeout(pollTestResults, 2000);
                    } else if (result.status === 'completed' || result.status === 'failed') {
                        console.log('Found completed test results');
                        const statusDiv = document.getElementById('testStatus');
                        const toggleLogsBtn = document.getElementById('toggleLogsBtn');
                        
                        // Show final status
                        const color = result.success ? '#28a745' : '#dc3545';
                        const icon = result.success ? '‚úÖ' : '‚ùå';
                        statusDiv.innerHTML = `<span style="color: ${color};">${icon} ${result.message}</span>`;
                        
                        // Show logs and controls
                        const logsDiv = document.getElementById('testLogs');
                        if (result.logs) {
                            logsDiv.textContent = result.logs;
                        }
                        
                        // Make artifacts available
                        resetTestUI('Run Playwright Tests');
                    }
                }
            } catch (error) {
                console.error('Error checking initial test status:', error);
            }
        }

        // Initialize when DOM is ready
        function initializePage() {
            // Add action buttons on page load
            services.forEach(service => {
                const element = document.getElementById(service.id);
                if (element) {
                    addActionButtons(service, element);
                }
            });
            
            // Add event listener for test button
            const runTestsBtn = document.getElementById('runTestsBtn');
            if (runTestsBtn) {
                runTestsBtn.addEventListener('click', runPlaywrightTests);
                console.log('Test button event listener added');
                
                // Test button is always enabled since dependencies are handled by Docker Compose
            } else {
                console.error('runTestsBtn not found');
            }
            
            // Add event listener for toggle logs button
            const toggleLogsBtn = document.getElementById('toggleLogsBtn');
            if (toggleLogsBtn) {
                toggleLogsBtn.addEventListener('click', toggleLogs);
            }
            
            // Check for existing test status first
            checkInitialTestStatus();
            
            // Start countdown timer (updates every second)
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // Initial check and then every 10 seconds
            checkAllServices();
            setInterval(checkAllServices, 10000);
            
            console.log('Status page initialized');
        }
        

        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>
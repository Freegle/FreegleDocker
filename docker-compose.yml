services:
  # Base image - must be built first, all other containers depend on it
  base:
    image: freegle-base:latest
    build:
      context: .
      dockerfile: Dockerfile.base
    command: ["true"]  # Exits immediately, just used for building
    profiles:
      - build  # Only runs when explicitly requested or as dependency

  reverse-proxy:
    container_name: freegle-traefik
    networks:
      - default
    image: traefik:latest
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.encodedcharacters.allowencodedslash=true"
      - "--entrypoints.api.address=:8192"
      - "--entrypoints.api.http.encodedcharacters.allowencodedslash=true"
      - "--entrypoints.traefik.address=:8080"
      - "--accesslog=true"
      - "--entrypoints.web.forwardedHeaders.insecure=true"
    ports:
      - "80:80"
      - "8192:8192"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/dashboard/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  percona:
    container_name: freegle-percona
    networks:
      - default
    image: percona:8.0.43-34
    restart: always
    volumes:
      - freegle_db:/var/lib/mysql
      - ./conf/percona-my.cnf:/etc/my.cnf:ro
    environment:
      MYSQL_ROOT_PASSWORD: iznik
      MYSQL_DATABASE: iznik
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -P 3306 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 60s

  postgres:
    container_name: freegle-postgres
    networks:
      - default
    image: postgis/postgis:13-3.1
    restart: "no"
    environment:
      POSTGRES_DB: iznik
      POSTGRES_PASSWORD: iznik
      POSTGRES_USER: root
    healthcheck:
      test: ["CMD-SHELL", "psql -h localhost -U root -d iznik -c 'SELECT 1' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s

  phpmyadmin:
    container_name: freegle-phpmyadmin
    networks:
      - default
    image: phpmyadmin
    ports:
      - "0.0.0.0:8086:80"
    depends_on:
      percona:
        condition: service_started
      reverse-proxy:
        condition: service_started
    restart: "no"
    environment:
      - PMA_HOST=percona
      - PMA_USER=root
      - PMA_PASSWORD=${MYSQL_PRODUCTION_ROOT_PASSWORD:-iznik}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.localhost`)"
      - "traefik.http.routers.phpmyadmin.entrypoints=web"
      - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"

  mailpit:
    image: axllent/mailpit:latest
    container_name: freegle-mailpit
    networks:
      - default
    ports:
      - "0.0.0.0:8025:8025"
      - "0.0.0.0:1025:1025"
    depends_on:
      percona:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      beanstalkd:
        condition: service_healthy
      spamassassin-app:
        condition: service_healthy
      rspamd:
        condition: service_healthy
      reverse-proxy:
        condition: service_healthy
    environment:
      - MP_SMTP_AUTH_ACCEPT_ANY=true
      - MP_SMTP_AUTH_ALLOW_INSECURE=true
      - MP_ENABLE_SPAMASSASSIN=spamassassin-app:783
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8025/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailpit.rule=Host(`mailpit.localhost`)"
      - "traefik.http.routers.mailpit.entrypoints=web"
      - "traefik.http.services.mailpit.loadbalancer.server.port=8025"

  beanstalkd:
    image: schickling/beanstalkd
    container_name: freegle-beanstalkd
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 11300 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  spamassassin-app:
    image: tiredofit/spamassassin
    container_name: freegle-spamassassin
    networks:
      - default
    ports:
      - 783:783
    volumes:
      - ./logs/spamassassin:/logs
      - ./conf:/config
      - ./data:/data
    environment:
      - CONTAINER_NAME=spamassassin-app
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 783"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  rspamd:
    image: rspamd/rspamd:latest
    container_name: freegle-rspamd
    networks:
      - default
    ports:
      - "11334:11334"
    volumes:
      - ./conf/rspamd/local.d:/etc/rspamd/local.d:ro
      - rspamd_data:/var/lib/rspamd
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_SERVERS=redis:6379
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL", "rspamadm control stat > /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rspamd.rule=Host(`rspamd.localhost`)"
      - "traefik.http.routers.rspamd.entrypoints=web"
      - "traefik.http.services.rspamd.loadbalancer.server.port=11334"

  redis:
    container_name: freegle-redis
    networks:
      - default
    image: redis:6.2-alpine
    restart: "no"
    command: redis-server --save 20 1 --loglevel warning
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  delivery:
    container_name: freegle-delivery
    networks:
      - default
    image: ghcr.io/weserv/images:5.x
    restart: "no"
    shm_size: 1gb
    depends_on:
      - tusd
      - freegle-dev-local
      - freegle-prod-local
      - modtools-dev-local
      - modtools-prod-local
    extra_hosts:
      - "tusd.localhost:host-gateway"
      - "freegle-dev-local.localhost:host-gateway"
      - "freegle-prod-local.localhost:host-gateway"
    volumes:
      - ./delivery-nginx.conf:/etc/nginx/nginx.conf:ro
      - ./delivery-imagesweserv.conf:/etc/nginx/imagesweserv.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.delivery.rule=Host(`delivery.localhost`)"
      - "traefik.http.routers.delivery.entrypoints=web"
      - "traefik.http.services.delivery.loadbalancer.server.port=80"

  tusd:
    image: tusproject/tusd:latest
    container_name: freegle-tusd
    networks:
      default:
        aliases:
          - tusd.localhost
    ports:
      - "1080:8080"
    command: -hooks-http=http://freegle-apiv1:80/api/image -hooks-enabled-events=pre-create,post-finish -base-path=/tus/ -cors-allow-headers=baggage,sentry-trace
    depends_on:
      reverse-proxy:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/tus/ 2>&1 | grep -E '(200|405)' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tusd.rule=Host(`tusd.localhost`)"
      - "traefik.http.routers.tusd.entrypoints=web"
      - "traefik.http.routers.tusd.middlewares=tusd-cors-headers"
      - "traefik.http.services.tusd.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.tusd-cors-headers.headers.customresponseheaders.Access-Control-Allow-Headers=Authorization, Origin, X-Requested-With, X-Request-ID, X-HTTP-Method-Override, Content-Type, Upload-Length, Upload-Offset, Tus-Resumable, Upload-Metadata, Upload-Defer-Length, Upload-Concat, Upload-Complete, Upload-Draft-Interop-Version, x-token, baggage, sentry-trace"

  status:
    build:
      context: ./status
      network: host
    container_name: freegle-status
    networks:
      - default
    ports:
      - "8081:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.status.rule=Host(`status.localhost`)"
      - "traefik.http.routers.status.entrypoints=web"
      - "traefik.http.services.status.loadbalancer.server.port=80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./status/index.html:/app/index.html:ro
      - ./status/logs.html:/app/logs.html:ro
      - ./status/server.js:/app/server.js:ro
      - ./ssl/certs:/app/ssl:ro
      - .:/project:ro
      - ./status/data:/app/data:rw
      - rebuild-requests:/rebuild-requests
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock

  ai-support-helper:
    build:
      context: ./claude-agent-sdk
      network: host
    container_name: freegle-ai-support-helper
    networks:
      - default
    ports:
      - "8083:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai-support-helper.rule=Host(`ai-support-helper.localhost`)"
      - "traefik.http.routers.ai-support-helper.entrypoints=web"
      - "traefik.http.services.ai-support-helper.loadbalancer.server.port=3000"
    environment:
      # Anthropic API key for Claude API calls
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  host-scripts:
    image: alpine:latest
    container_name: freegle-host-scripts
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace
      - rebuild-requests:/rebuild-requests
    working_dir: /workspace
    command:
      - sh
      - -c
      - |
        apk add --no-cache docker-cli docker-compose jq bash inotify-tools
        echo 'Starting rebuild monitor and file sync...'
        (
          echo 'Starting rebuild monitor...'
          while true; do
            for request_file in /rebuild-requests/rebuild-*.json; do
              [ ! -f "$$request_file" ] && continue
              echo "Processing rebuild request: $$request_file"
              service=$$(jq -r '.service' "$$request_file" 2>/dev/null)
              container=$$(jq -r '.container' "$$request_file" 2>/dev/null)
              if [ "$$service" != "null" ] && [ "$$container" != "null" ]; then
                echo "Rebuilding service: $$service ($$container)"
                if docker-compose -p freegledockerwsl stop "$$service" && 
                   docker-compose -p freegledockerwsl rm -f "$$service" && 
                   docker-compose -p freegledockerwsl build "$$service" && 
                   docker-compose -p freegledockerwsl up --no-deps -d "$$service"; then
                  echo "Rebuild completed successfully for $$service"
                else
                  echo "Rebuild failed for $$service"
                fi
              fi
              rm -f "$$request_file"
            done
            sleep 2
          done
        ) &
        echo 'Starting file sync in background...'
        bash ./file-sync.sh &
        SYNC_PID=$$!

        # Keep container running
        while true; do
          if ! kill -0 $$SYNC_PID 2>/dev/null; then
            echo "File sync stopped, restarting..."
            bash ./file-sync.sh &
            SYNC_PID=$$!
          fi
          sleep 10
        done
    restart: unless-stopped

  # Freegle images.
  apiv1:
    container_name: freegle-apiv1
    networks:
      - default
    build:
      context: ./iznik-server
      network: host
    depends_on:
      percona:
        condition: service_healthy
      beanstalkd:
        condition: service_started
      mailpit:
        condition: service_started
      redis:
        condition: service_started
      spamassassin-app:
        condition: service_started
    restart: "no"
    environment:
      - MYSQL_HOST=percona
      - MYSQL_PORT=3306
      - MYSQL_PASSWORD=${MYSQL_PRODUCTION_ROOT_PASSWORD:-iznik}
      - SKIP_DB_INIT=${SKIP_DB_INIT:-false}
      - PHEANSTALK_SERVER=beanstalkd
      - REDIS_CONNECT=redis
      - IMAGE_DOMAIN=apiv1
      - SPAMD_HOST=spamassassin-app
      - SPAMD_PORT=783
      - SMTP_HOST=mailpit
      - TUS_UPLOADER=http://freegle-tusd:8080/tus
      - SMTP_PORT=1025
      - IMAGE_DELIVERY=http://freegle-delivery
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GOOGLE_PUSH_KEY=${GOOGLE_PUSH_KEY:-}
      - GOOGLE_VISION_KEY=${GOOGLE_VISION_KEY:-}
      - GOOGLE_PERSPECTIVE_KEY=${GOOGLE_PERSPECTIVE_KEY:-}
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY:-}
      - GOOGLE_PROJECT=${GOOGLE_PROJECT:-}
      - GOOGLE_APP_NAME=${GOOGLE_APP_NAME:-}
      - MAPBOX_KEY=${MAPBOX_KEY:-}
      - MAXMIND_ACCOUNT=${MAXMIND_ACCOUNT:-}
      - MAXMIND_KEY=${MAXMIND_KEY:-}
      - LOKI_ENABLED=true
      - LOKI_URL=http://loki:3100
    volumes:
      - geoip_data:/var/lib/GeoIP
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/api/config || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.apiv1.rule=Host(`apiv1.localhost`)"
      - "traefik.http.routers.apiv1.entrypoints=web"
      - "traefik.http.routers.apiv1.middlewares=apiv1-cors"
      - "traefik.http.services.apiv1-localhost-freegledocker.loadbalancer.server.port=80"
      - "traefik.http.middlewares.limit.buffering.maxRequestBodyBytes=8000000"
      - "traefik.http.middlewares.apiv1-cors.headers.customresponseheaders.Access-Control-Allow-Origin=*"
      - "traefik.http.middlewares.apiv1-cors.headers.customresponseheaders.Access-Control-Allow-Methods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.apiv1-cors.headers.customresponseheaders.Access-Control-Allow-Headers=*"
      - "traefik.http.middlewares.apiv1-cors.headers.customresponseheaders.Access-Control-Max-Age=86400"
    secrets:
      - LOVE_JUNK_API
      - LOVE_JUNK_SECRET
      - PARTNER_KEY
      - PARTNER_NAME
      - IMAGE_DOMAIN
    ports:
      - "1023:22"
      - "83:80"
      - "8181:80"

  apiv2:
    container_name: freegle-apiv2
    networks:
      default:
        aliases:
          - apiv2.localhost
    build:
      context: ./iznik-server-go
      network: host
      args:
        IZNIK_SERVER_GO_BRANCH: ${IZNIK_SERVER_GO_BRANCH:-master}
    depends_on:
      percona:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      beanstalkd:
        condition: service_healthy
      reverse-proxy:
        condition: service_healthy
    restart: "no"
    environment:
      - MYSQL_HOST=percona
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_PRODUCTION_ROOT_PASSWORD:-iznik}
      - IMAGE_DELIVERY=http://delivery.localhost
      - TUS_UPLOADER=http://freegle-tusd:8080/tus
      - PARTNER_KEY_FILE=/run/secrets/PARTNER_KEY
      - LOKI_ENABLED=true
      - LOKI_URL=http://loki:3100
      - LOKI_JSON_PATH=/var/log/freegle
      # Allowed domains for email tracking redirects
      - USER_SITE=www.ilovefreegle.org
      - IMAGE_DOMAIN=images.ilovefreegle.org
      - GROUP_DOMAIN=groups.ilovefreegle.org
    volumes:
      - apiv2_logs:/var/log/freegle
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8192/apiv2/online || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    ports:
      - "8193:8192"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.apiv2.rule=Host(`apiv2.localhost`)"
      - "traefik.http.routers.apiv2.entrypoints=web"
      - "traefik.http.routers.apiv2.middlewares=apiv2-cors"
      - "traefik.http.services.apiv2.loadbalancer.server.port=8192"
      - "traefik.http.middlewares.apiv2-cors.headers.customresponseheaders.Access-Control-Allow-Origin=*"
      - "traefik.http.middlewares.apiv2-cors.headers.customresponseheaders.Access-Control-Allow-Methods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.apiv2-cors.headers.customresponseheaders.Access-Control-Allow-Headers=*"
      - "traefik.http.middlewares.apiv2-cors.headers.customresponseheaders.Access-Control-Max-Age=86400"

  # Development build with local APIs - standard dev workflow
  freegle-dev-local:
    container_name: freegle-dev-local
    networks:
      default:
        aliases:
          - freegle-dev-local.localhost
    ports:
      - "0.0.0.0:3002:3002"
    extra_hosts:
      - "apiv1.localhost:host-gateway"
      - "apiv2.localhost:host-gateway"
    build:
      context: ./iznik-nuxt3
      network: host
      args:
        IZNIK_NUXT3_BRANCH: ${IZNIK_NUXT3_BRANCH:-master}
    tmpfs:
      - /tmp
    depends_on:
      phpmyadmin:
        condition: service_started
      mailpit:
        condition: service_started
      apiv1:
        condition: service_healthy
      apiv2:
        condition: service_started
    restart: "no"
    environment:
      - IZNIK_API_V1=http://apiv1.localhost/api
      - IZNIK_API_V2=http://apiv2.localhost/api
      - IMAGE_DELIVERY=http://delivery.localhost
      - TUS_UPLOADER=http://tusd.localhost/tus/
      - USER_SITE=http://freegle-dev-local.localhost:3002
      - IMAGE_BASE_URL=http://freegle-tusd:8080/tus
      - TUSD_URL=http://freegle-tusd:8080
      - NITRO_PRESET=node-server
      - NUXT_NITRO_PRERENDER_ROUTES=false
      - NUXT_DEV_MODE=true
      - NUXT_SSR_LOG=false
      - NODE_ENV=development
      - NUXT_BUILD_MODE=development
      - TEST_BASE_URL=http://127.0.0.1:3002
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-dev-local.rule=Host(`freegle-dev-local.localhost`)"
      - "traefik.http.routers.freegle-dev-local.entrypoints=web"
      - "traefik.http.services.freegle-dev-local.loadbalancer.server.port=3002"

  # Development build with LIVE/PRODUCTION APIs - for mobile dev and testing with real data
  # WARNING: Actions in this container affect REAL Freegle data!
  # Not started by default - use status page button to start with confirmation
  freegle-dev-live:
    container_name: freegle-dev-live
    depends_on:
      - host-scripts
      - status
      - reverse-proxy
    profiles:
      - dev-live
    networks:
      default:
        aliases:
          - freegle-dev-live.localhost
    ports:
      - "0.0.0.0:3005:3002"
    build:
      context: ./iznik-nuxt3
      network: host
      args:
        IZNIK_NUXT3_BRANCH: ${IZNIK_NUXT3_BRANCH:-master}
    tmpfs:
      - /tmp
    restart: "no"
    environment:
      # LIVE/Production APIs - REAL DATA!
      - IZNIK_API_V1=https://fdapilive.ilovefreegle.org/api
      - IZNIK_API_V2=https://api.ilovefreegle.org/apiv2
      # Use production delivery and USER_SITE - local delivery won't work
      # from mobile devices since they can't resolve localhost hostnames
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org
      - TUS_UPLOADER=https://uploads.ilovefreegle.org:8080
      - USER_SITE=https://www.ilovefreegle.org
      - NITRO_PRESET=node-server
      - NUXT_NITRO_PRERENDER_ROUTES=false
      - NUXT_DEV_MODE=true
      - NUXT_SSR_LOG=false
      - NODE_ENV=development
      - NUXT_BUILD_MODE=development
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-dev-live.rule=Host(`freegle-dev-live.localhost`)"
      - "traefik.http.routers.freegle-dev-live.entrypoints=web"
      - "traefik.http.services.freegle-dev-live.loadbalancer.server.port=3002"

  # Production build with local APIs - for testing production builds locally
  freegle-prod-local:
    container_name: freegle-prod-local
    networks:
      default:
        aliases:
          - freegle-prod-local.localhost
    ports:
      - "0.0.0.0:3012:3003"
    extra_hosts:
      - "apiv1.localhost:host-gateway"
      - "apiv2.localhost:host-gateway"
    build:
      context: ./iznik-nuxt3
      dockerfile: Dockerfile.prod
      network: host
      args:
        IZNIK_NUXT3_BRANCH: ${IZNIK_NUXT3_BRANCH:-master}
    tmpfs:
      - /tmp
    depends_on:
      phpmyadmin:
        condition: service_started
      mailpit:
        condition: service_started
      apiv1:
        condition: service_healthy
      apiv2:
        condition: service_started
    restart: "no"
    environment:
      - IZNIK_API_V1=http://apiv1.localhost/api
      - IZNIK_API_V2=http://apiv2.localhost/api
      - IMAGE_DELIVERY=http://delivery.localhost
      - TUS_UPLOADER=http://tusd.localhost/tus/
      - USER_SITE=http://freegle-prod-local.localhost:3003
      - IMAGE_BASE_URL=http://freegle-tusd:8080/tus
      - TUSD_URL=http://freegle-tusd:8080
      - NITRO_PRESET=node-server
      - NUXT_NITRO_PRERENDER_ROUTES=false
      - NUXT_DEV_MODE=false
      - NUXT_SSR_LOG=false
      - NODE_ENV=production
      - NUXT_BUILD_MODE=production
      - TEST_BASE_URL=http://127.0.0.1:3003
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-prod-local.rule=Host(`freegle-prod-local.localhost`)"
      - "traefik.http.routers.freegle-prod-local.entrypoints=web"
      - "traefik.http.services.freegle-prod-local.loadbalancer.server.port=3003"

  # Development build with local APIs - ModTools
  modtools-dev-local:
    container_name: modtools-dev-local
    networks:
      default:
        aliases:
          - modtools-dev-local.localhost
    ports:
      - "0.0.0.0:3003:3000"
    extra_hosts:
      - "apiv1.localhost:host-gateway"
      - "apiv2.localhost:host-gateway"
    build:
      context: .
      dockerfile: ./iznik-nuxt3-modtools/modtools/Dockerfile
      network: host
      args:
        IZNIK_NUXT3_MODTOOLS_BRANCH: ${IZNIK_NUXT3_MODTOOLS_BRANCH:-master}
    tmpfs:
      - /tmp
    depends_on:
      phpmyadmin:
        condition: service_started
      mailpit:
        condition: service_started
      apiv1:
        condition: service_healthy
      apiv2:
        condition: service_started
    restart: "no"
    environment:
      - IZNIK_API_V1=http://apiv1.localhost/api
      - IZNIK_API_V2=http://apiv2.localhost/api
      - IMAGE_DELIVERY=http://delivery.localhost
      - TUS_UPLOADER=http://tusd.localhost/tus/
      - IMAGE_BASE_URL=http://freegle-tusd:8080/tus
      - TUSD_URL=http://freegle-tusd:8080
      - USER_SITE=http://modtools-dev-local.localhost:3000
      - OSM_TILE=https://tiles.ilovefreegle.org/tile/{z}/{x}/{y}.png
      - NITRO_PRESET=node-server
      - NUXT_DEV_MODE=true
      - NUXT_SSR_LOG=false
      - NODE_ENV=development
      - NUXT_BUILD_MODE=development
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-dev-local.rule=Host(`modtools-dev-local.localhost`)"
      - "traefik.http.routers.modtools-dev-local.entrypoints=web"
      - "traefik.http.services.modtools-dev-local.loadbalancer.server.port=3000"

  # Development mode with LIVE/Production APIs - ModTools
  # WARNING: This connects to REAL production data!
  modtools-dev-live:
    container_name: modtools-dev-live
    depends_on:
      - host-scripts
      - status
      - reverse-proxy
    profiles:
      - dev-live
    networks:
      default:
        aliases:
          - modtools-dev-live.localhost
    ports:
      - "0.0.0.0:3006:3000"
    build:
      context: .
      dockerfile: ./iznik-nuxt3-modtools/modtools/Dockerfile
      network: host
      args:
        IZNIK_NUXT3_MODTOOLS_BRANCH: ${IZNIK_NUXT3_MODTOOLS_BRANCH:-master}
    tmpfs:
      - /tmp
    restart: "no"
    environment:
      # LIVE/Production APIs - REAL DATA!
      - IZNIK_API_V1=https://fdapilive.ilovefreegle.org/api
      - IZNIK_API_V2=https://api.ilovefreegle.org/apiv2
      # Use production delivery and USER_SITE - local delivery won't work
      # from mobile devices since they can't resolve localhost hostnames
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org
      - TUS_UPLOADER=https://uploads.ilovefreegle.org:8080
      - USER_SITE=https://modtools.ilovefreegle.org
      - OSM_TILE=https://tiles.ilovefreegle.org/tile/{z}/{x}/{y}.png
      - NITRO_PRESET=node-server
      - NUXT_DEV_MODE=true
      - NUXT_SSR_LOG=false
      - NODE_ENV=development
      - NUXT_BUILD_MODE=development
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-dev-live.rule=Host(`modtools-dev-live.localhost`)"
      - "traefik.http.routers.modtools-dev-live.entrypoints=web"
      - "traefik.http.services.modtools-dev-live.loadbalancer.server.port=3000"

  # Production build with local APIs - ModTools
  modtools-prod-local:
    container_name: modtools-prod-local
    networks:
      default:
        aliases:
          - modtools-prod-local.localhost
    ports:
      - "0.0.0.0:3013:3001"
    extra_hosts:
      - "apiv1.localhost:host-gateway"
      - "apiv2.localhost:host-gateway"
    build:
      context: ./iznik-nuxt3-modtools
      dockerfile: modtools/Dockerfile.prod
      network: host
      args:
        IZNIK_NUXT3_MODTOOLS_BRANCH: ${IZNIK_NUXT3_MODTOOLS_BRANCH:-master}
    tmpfs:
      - /tmp
    depends_on:
      phpmyadmin:
        condition: service_started
      mailpit:
        condition: service_started
      apiv1:
        condition: service_healthy
      apiv2:
        condition: service_started
    restart: "no"
    environment:
      - IZNIK_API_V1=http://apiv1.localhost/api
      - IZNIK_API_V2=http://apiv2.localhost/api
      - IMAGE_DELIVERY=http://delivery.localhost
      - TUS_UPLOADER=http://tusd.localhost/tus/
      - IMAGE_BASE_URL=http://freegle-tusd:8080/tus
      - TUSD_URL=http://freegle-tusd:8080
      - USER_SITE=http://modtools-prod-local.localhost:3001
      - OSM_TILE=https://tiles.ilovefreegle.org/tile/{z}/{x}/{y}.png
      - NITRO_PRESET=node-server
      - NUXT_DEV_MODE=false
      - NUXT_SSR_LOG=false
      - NODE_ENV=production
      - NUXT_BUILD_MODE=production
      - TEST_BASE_URL=http://127.0.0.1:3001
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-prod-local.rule=Host(`modtools-prod-local.localhost`)"
      - "traefik.http.routers.modtools-prod-local.entrypoints=web"
      - "traefik.http.services.modtools-prod-local.loadbalancer.server.port=3001"

  playwright:
    container_name: freegle-playwright
    network_mode: "host"
    shm_size: 2gb  # Chrome needs more shared memory for parallel browser instances
    build:
      context: ./iznik-nuxt3
      dockerfile: Dockerfile.playwright
      network: host
    working_dir: /app
    extra_hosts:
      - "freegle-dev-local.localhost:127.0.0.1"
      - "freegle-prod-local.localhost:127.0.0.1"
      - "freegle-dev-live.localhost:127.0.0.1"
      - "modtools-dev-local.localhost:127.0.0.1"
      - "modtools-prod-local.localhost:127.0.0.1"
      - "apiv1.localhost:127.0.0.1"
      - "apiv2.localhost:127.0.0.1"
      - "delivery.localhost:127.0.0.1"
    volumes:
      - ./iznik-nuxt3/tests:/host-tests:ro
      - ./iznik-nuxt3:/app/src:ro
      - ./iznik-nuxt3:/host-playwright-config:ro
    environment:
      - TEST_BASE_URL=http://freegle-prod-local.localhost
      - TEST_MODTOOLS_BASE_URL=http://modtools-prod-local.localhost
      - NODE_ENV=test
      - CI=false
      - ENABLE_MONOCART_REPORTER=true
      - COVERALLS_REPO_TOKEN=${COVERALLS_REPO_TOKEN:-}
    depends_on:
      freegle-dev-local:
        condition: service_started
      freegle-prod-local:
        condition: service_started
      modtools-prod-local:
        condition: service_started
      apiv1:
        condition: service_healthy
      apiv2:
        condition: service_started
      reverse-proxy:
        condition: service_healthy
      percona:
        condition: service_healthy
      redis:
        condition: service_healthy
      beanstalkd:
        condition: service_healthy

  # Loki - Log aggregation (optional, enabled by LOKI_ENABLED env var)
  loki:
    container_name: freegle-loki
    image: grafana/loki:2.9.0
    networks:
      - default
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
      - ./conf/loki-config.yaml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loki.rule=Host(`loki.localhost`)"
      - "traefik.http.routers.loki.entrypoints=web"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"

  # Grafana - Log visualization (optional, depends on Loki)
  grafana:
    container_name: freegle-grafana
    image: grafana/grafana:latest
    networks:
      - default
    ports:
      - "3200:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./conf/grafana-provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-freegle}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
    depends_on:
      loki:
        condition: service_healthy
    restart: "no"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.localhost`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # Batch jobs processor (Laravel)
  batch:
    container_name: freegle-batch
    networks:
      - default
    build:
      context: ./iznik-batch
      dockerfile: docker/Dockerfile
    volumes:
      - ./iznik-batch:/var/www/html
      - ./iznik-server:/var/www/iznik:ro
      - batch-vendor:/var/www/html/vendor
      - batch-bootstrap-cache:/var/www/html/bootstrap/cache
    depends_on:
      percona:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailpit:
        condition: service_started
    restart: "no"
    environment:
      - APP_NAME=Freegle Batch Jobs
      - APP_KEY=base64:JXsa9TVxy8PQIrAgimIh0+4v8U7rSYhd3/+an8WYYQc=
      - APP_ENV=local
      - APP_DEBUG=true
      - RUN_MIGRATIONS=true
      - APP_URL=http://localhost
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=mysql
      - DB_HOST=percona
      - DB_PORT=3306
      - DB_DATABASE=iznik
      - DB_USERNAME=root
      - DB_PASSWORD=iznik
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_STORE=redis
      - QUEUE_CONNECTION=redis
      - SESSION_DRIVER=redis
      - MAIL_MAILER=smtp
      - MAIL_HOST=mailpit
      - MAIL_PORT=1025
      - MAIL_ENCRYPTION=null
      - MAIL_EHLO_DOMAIN=freegle-batch
      - FREEGLE_USER_SITE=http://freegle-dev-local.localhost:3002
      - FREEGLE_MOD_SITE=http://modtools-dev-local.localhost:3003
      - FREEGLE_API_BASE_URL=http://localhost:8193
      - FREEGLE_DELIVERY_URL=http://delivery.localhost
      - LOKI_ENABLED=true
      - LOKI_URL=http://loki:3100
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/laravel-ready && php artisan about > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  rebuild-requests:
    driver: local
  freegle_db: {}
  phpmyadmin-sessions:
    driver: local
  geoip_data:
    driver: local
  batch-vendor:
    driver: local
  batch-bootstrap-cache:
    driver: local
  rspamd_data:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local
  apiv2_logs:
    driver: local

networks:
  default:
    driver: bridge

secrets:
  LOVE_JUNK_API:
    file: ./secrets/lovejunk-api.txt
  LOVE_JUNK_SECRET:
    file: ./secrets/lovejunk-secret.txt
  PARTNER_KEY:
    file: ./secrets/partner-key.txt
  PARTNER_NAME:
    file: ./secrets/partner-name.txt
  IMAGE_DOMAIN:
    file: ./secrets/image-domain.txt

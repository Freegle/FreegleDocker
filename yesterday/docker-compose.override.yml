# Docker Compose Override for Yesterday Backup/Restore Environment
#
# PURPOSE:
# This file configures the FreegleDocker stack to work with restored production backups
# on the Yesterday server. It overrides settings from the base docker-compose.yml.
#
# USAGE:
# 1. Yesterday restore script (yesterday/scripts/restore-backup.sh) copies this file
#    to the repository root as docker-compose.override.yml
# 2. Docker Compose automatically merges this with docker-compose.yml when running
# 3. CircleCI explicitly uses '-f docker-compose.yml' to skip this override
#
# KEY DIFFERENCES FROM BASE CONFIG:
# - Uses production image/upload services (images.ilovefreegle.org, tus.ilovefreegle.org)
# - Mounts MySQL config files generated by restore script
# - Sets freegle_db volume as external (restored from backup)
# - Uses production database password from .env
#
# DO NOT EDIT THE ROOT docker-compose.override.yml - IT IS AUTO-GENERATED!
# This file (yesterday/docker-compose.override.yml) is the single source of truth.

services:
  reverse-proxy:
    # Add HTTPS entrypoints for dev/prod containers and APIs with Let's Encrypt
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.api.address=:8192"
      - "--entrypoints.traefik.address=:8080"
      - "--entrypoints.freegle-dev.address=:3002"
      - "--entrypoints.modtools-dev.address=:3003"
      - "--entrypoints.freegle-prod.address=:3012"
      - "--entrypoints.modtools-prod.address=:3013"
      - "--entrypoints.delivery.address=:8095"
      # API entrypoints removed - access via Yesterday 2FA gateway on ports 8181/8193 only
      # PHPMyAdmin and Mailhog entrypoints removed - access via 2FA gateway only
      - "--accesslog=true"
      - "--entrypoints.web.forwardedHeaders.insecure=true"
      - "--certificatesresolvers.letsencrypt.acme.email=geeks@ilovefreegle.org"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=gcloud"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=30"
      - "--log.level=INFO"
      - "--ping=true"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s  # Increased from 10s to handle I/O load after Loki restore
    ports:
      - "80:80"
      - "8192:8192"
      - "8080:8080"
      - "0.0.0.0:3002:3002"
      - "0.0.0.0:3003:3003"
      - "0.0.0.0:3012:3012"
      - "0.0.0.0:3013:3013"
      - "0.0.0.0:8095:8095"
      # Ports 8181/8193 (APIs), 8086 (phpmyadmin) and 8025 (mailpit) removed - access via 2FA gateway only
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/traefik/secrets/gcloud-dns-key.json:/secrets/gcloud-dns-key.json:ro
      - ./data/main-letsencrypt:/letsencrypt
    environment:
      - GCE_PROJECT=freegle-1139
      - GCE_SERVICE_ACCOUNT_FILE=/secrets/gcloud-dns-key.json

  yesterday-ssl-proxy:
    # Internal proxy to Yesterday HTTPS with SSL verification disabled
    # Serves HTTPS with self-signed cert, proxies to real Yesterday server
    container_name: yesterday-ssl-proxy
    image: nginx:alpine
    restart: "no"
    extra_hosts:
      - "${YESTERDAY_HOSTNAME}:host-gateway"
    volumes:
      - ./yesterday/yesterday-ssl-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./yesterday/ssl:/etc/nginx/ssl:ro
    networks:
      default:
        aliases:
          - yesterday.ilovefreegle.org

  delivery:
    # Local delivery container for Yesterday - proxies/transforms images
    # Resolves yesterday.ilovefreegle.org to yesterday-ssl-proxy via network alias
    # The proxy handles SSL verification and forwards to the real Yesterday server
    # Empty CA bundle disables SSL verification for self-signed cert on proxy
    # Routed through Traefik for SSL termination on port 8095
    depends_on:
      - yesterday-ssl-proxy
    ports: !reset []
    volumes:
      - ./yesterday/ssl/empty-ca-bundle.crt:/etc/ssl/certs/ca-certificates.crt:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.delivery.rule=Host(`${YESTERDAY_HOSTNAME}`)"
      - "traefik.http.routers.delivery.entrypoints=delivery"
      - "traefik.http.routers.delivery.tls.certresolver=letsencrypt"
      - "traefik.http.routers.delivery.tls.domains[0].main=${YESTERDAY_HOSTNAME}"
      - "traefik.http.services.delivery.loadbalancer.server.port=80"

  percona:
    # Mount MySQL server config generated by restore script with InnoDB settings from backup
    # File: ./conf/percona-my.cnf (created during restore process, persists across reboots)
    # Expose MySQL port for direct access from whitelisted IPs (bulk3.ilovefreegle.org)
    # Access controlled via GCP firewall rules
    ports:
      - "3306:3306"
    volumes:
      - ./conf/percona-my.cnf:/etc/my.cnf:ro

  phpmyadmin:
    # Accessed via 2FA gateway at /phpmyadmin (Admin only)
    # No direct external access - only through yesterday-2fa gateway
    # Basic auth disabled - authentication handled by 2FA gateway
    # Custom config files disable token validation since 2FA gateway protects access
    # Patched Common.php bypasses CSRF token validation (no config option exists)
    ports: !reset []
    volumes:
      - phpmyadmin-sessions:/sessions
      - ./yesterday/phpmyadmin-config.php:/etc/phpmyadmin/config.user.inc.php:ro
      - ./yesterday/phpmyadmin-prepend.php:/var/www/html/phpmyadmin-prepend.php:ro
      - ./yesterday/phpmyadmin-php.ini:/usr/local/etc/php/conf.d/zzz-phpmyadmin.ini:ro
      - ./yesterday/phpmyadmin-Common.php:/var/www/html/libraries/classes/Common.php:ro
    environment:
      - PMA_HOST=percona
      - PMA_USER=root
      - PMA_PASSWORD=${MYSQL_PRODUCTION_ROOT_PASSWORD:-iznik}
      - ADMIN_TOOLS_BASIC_AUTH=
      - PMA_ABSOLUTE_URI=https://${YESTERDAY_HOSTNAME}:8447/
    labels:
      - "traefik.enable=false"

  mailpit:
    # Accessed via 2FA gateway at /mailpit (Admin only)
    # No direct external access - only through yesterday-2fa gateway
    # Basic auth disabled - authentication handled by 2FA gateway
    ports: !reset []
    environment:
      - ADMIN_TOOLS_BASIC_AUTH=
    labels:
      - "traefik.enable=false"

  apiv1:
    # Accessible only through Yesterday 2FA gateway on port 8181
    # Mount MySQL client config with production database password
    # File: ./iznik-server-my.cnf (created by scripts/generate-mysql-configs.sh)
    ports: !reset []
    volumes:
      - ./iznik-server-my.cnf:/root/.my.cnf:ro
    labels:
      - "traefik.enable=false"
    # Simplified startup command for Yesterday - skips DB initialization (schema.sql, testenv.php, etc)
    # to preserve restored production data
    command: >
      /bin/sh -c "sed -i \"s/define('SQLPASSWORD', '.*')/define('SQLPASSWORD', '\$$MYSQL_PASSWORD')/\" /etc/iznik.conf &&
      sed -i \"s/define('IMAGE_DOMAIN', '.*')/define('IMAGE_DOMAIN', 'delivery.ilovefreegle.org')/\" /etc/iznik.conf &&
      sed -i \"s/define('IMAGE_DELIVERY', NULL);/define('IMAGE_DELIVERY', 'https:\\/\\/delivery.ilovefreegle.org');/\" /etc/iznik.conf &&
      /etc/init.d/ssh start &&
      cp install/nginx.conf /etc/nginx/sites-available/default &&
      /etc/init.d/nginx start &&
      /etc/init.d/cron start &&
      /etc/init.d/php8.1-fpm start &&
      /etc/init.d/postfix start &&
      cd /var/www/iznik &&
      sh -c 'nohup sh -c \"while true; do cd /var/www/iznik/scripts/cron && php ./message_spatial.php >> /tmp/iznik.message_spatial.out 2>&1; sleep 10; done\" </dev/null >/dev/null 2>&1 & exec sleep infinity'"
    environment:
      # Use production image services so restored data displays correctly
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org

  apiv2:
    # Accessible only through Yesterday 2FA gateway on port 8193
    ports: !reset []
    labels:
      - "traefik.enable=false"
    # Use production image services
    environment:
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/

  batch:
    # Override database password for Yesterday's restored production database
    environment:
      - DB_PASSWORD=${MYSQL_PRODUCTION_ROOT_PASSWORD:-iznik}

  freegle-dev-local:
    # Routed through Traefik for SSL termination on port 3002
    # No direct port binding - Traefik handles HTTPS and proxies to container
    ports: !reset []
    extra_hosts:
      - "${YESTERDAY_HOSTNAME}:host-gateway"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-dev.rule=Host(`${YESTERDAY_HOSTNAME}`)"
      - "traefik.http.routers.freegle-dev.entrypoints=freegle-dev"
      - "traefik.http.routers.freegle-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.freegle-dev.tls.domains[0].main=${YESTERDAY_HOSTNAME}"
      - "traefik.http.routers.freegle-dev.service=freegle-dev"
      - "traefik.http.services.freegle-dev.loadbalancer.server.port=3002"
    environment:
      - IZNIK_API_V1=https://${YESTERDAY_HOSTNAME}:8181/api
      - IZNIK_API_V2=https://${YESTERDAY_HOSTNAME}:8193/api
      - IMAGE_DELIVERY=https://${YESTERDAY_HOSTNAME}:8095
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/
      - IMAGE_BASE_URL=https://uploads.ilovefreegle.org
      - USER_SITE=https://${YESTERDAY_HOSTNAME}:8445

  freegle-prod-local:
    # DISABLED: We only use dev containers on Yesterday
    # Reason: Dev containers start in seconds, prod containers take 10+ minutes to build
    # Production containers are disabled to save resources and startup time
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-prod.rule=Host(`${YESTERDAY_HOSTNAME}`)"
      - "traefik.http.routers.freegle-prod.entrypoints=freegle-prod"
      - "traefik.http.routers.freegle-prod.tls.certresolver=letsencrypt"
      - "traefik.http.routers.freegle-prod.tls.domains[0].main=${YESTERDAY_HOSTNAME}"
      - "traefik.http.routers.freegle-prod.service=freegle-prod"
      - "traefik.http.services.freegle-prod.loadbalancer.server.port=3000"
    environment:
      - USER_SITE=https://${YESTERDAY_HOSTNAME}:3012
    deploy:
      replicas: 0

  modtools-dev-local:
    # Routed through Traefik for SSL termination on port 3003
    # No direct port binding - Traefik handles HTTPS and proxies to container
    ports: !reset []
    extra_hosts:
      - "${YESTERDAY_HOSTNAME}:host-gateway"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-dev.rule=Host(`${YESTERDAY_HOSTNAME}`)"
      - "traefik.http.routers.modtools-dev.entrypoints=modtools-dev"
      - "traefik.http.routers.modtools-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.modtools-dev.tls.domains[0].main=${YESTERDAY_HOSTNAME}"
      - "traefik.http.routers.modtools-dev.service=modtools-dev"
      - "traefik.http.services.modtools-dev.loadbalancer.server.port=3000"
    environment:
      - IZNIK_API_V1=https://${YESTERDAY_HOSTNAME}:8181/api
      - IZNIK_API_V2=https://${YESTERDAY_HOSTNAME}:8193/api
      - IMAGE_DELIVERY=https://${YESTERDAY_HOSTNAME}:8095
      - IMAGE_BASE_URL=https://uploads.ilovefreegle.org
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/
      - USER_SITE=https://${YESTERDAY_HOSTNAME}:8446

  modtools-prod-local:
    # DISABLED: We only use dev containers on Yesterday
    # Reason: Dev containers start in seconds, prod containers take 10+ minutes to build
    # Production containers are disabled to save resources and startup time
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-prod.rule=Host(`${YESTERDAY_HOSTNAME}`)"
      - "traefik.http.routers.modtools-prod.entrypoints=modtools-prod"
      - "traefik.http.routers.modtools-prod.tls.certresolver=letsencrypt"
      - "traefik.http.routers.modtools-prod.tls.domains[0].main=${YESTERDAY_HOSTNAME}"
      - "traefik.http.routers.modtools-prod.service=modtools-prod"
      - "traefik.http.services.modtools-prod.loadbalancer.server.port=3000"
    environment:
      - USER_SITE=https://${YESTERDAY_HOSTNAME}:3013
    deploy:
      replicas: 0

  # MCP containers disabled on Yesterday - port 8084 conflicts with 2FA gateway
  # and MCP functionality is not needed for the Yesterday backup/restore system
  mcp-query-sanitizer:
    deploy:
      replicas: 0

  mcp-pseudonymizer:
    deploy:
      replicas: 0

  mcp-interface:
    deploy:
      replicas: 0

volumes:
  freegle_db:
    # Mark as external - this volume is populated by the restore script
    # with production backup data and should not be recreated by Docker
    external: true
  loki-data:
    # NOT external - Docker creates this automatically if it doesn't exist
    # The restore script will populate it with historical logs if available,
    # but Loki can start with an empty volume (no historical logs)
    # This prevents "external volume not found" errors if restore fails early
    driver: local

# Freegle local fuzzy hash storage
#
# Uses rspamd's built-in fuzzy storage worker (localhost:11335, Redis backend).
# Hashes expire after 90 days (configured in the fuzzy worker default).
#
# This enables detection of similar messages sent to multiple groups,
# even when the content is slightly mutated (e.g. different group names).
# The shingles algorithm matches if >50% of text shingles overlap.
#
# Learning: use rspamc to teach the fuzzy storage:
#   rspamc -f 1 -w 10 fuzzy_add <message>   # Flag 1 = denied (spam)
#   rspamc -f 2 -w 5  fuzzy_add <message>   # Flag 2 = probable spam
#   rspamc -f 1 fuzzy_del <message>          # Remove from denied
#
# The default rspamd.com rule (read-only) is preserved for global intelligence.
# This local rule adds our own learning capability.

rule "local" {
    # Point to the built-in fuzzy storage worker
    servers = "localhost:11335";
    algorithm = "mumhash";

    # Allow both reading and writing (learning)
    read_only = false;

    # Minimum message size to hash (bytes) - skip tiny messages
    min_bytes = 300;

    # Short text direct hash for small messages that can't generate shingles
    short_text_direct_hash = true;
    min_length = 32;

    # Fuzzy flag definitions
    fuzzy_map {
        # Flag 1: Known spam/phishing - high weight rejection
        LOCAL_FUZZY_DENIED {
            max_score = 20.0;
            flag = 1;
        }
        # Flag 2: Probable spam - moderate weight
        LOCAL_FUZZY_PROB {
            max_score = 10.0;
            flag = 2;
        }
        # Flag 3: Known good - whitelist
        LOCAL_FUZZY_WHITE {
            max_score = 2.0;
            flag = 3;
        }
    }
}

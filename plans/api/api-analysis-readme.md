# API Analysis Scripts

## Overview
This folder contains scripts for analyzing v1 API usage across the FD (Freegle) and MT (ModTools) codebases using jscodeshift for semantic JavaScript/Vue analysis.

## How the Analysis Works

### 1. Tool: jscodeshift
- **Why jscodeshift?** Unlike grep/search, it understands JavaScript AST (Abstract Syntax Tree)
- **Semantic understanding**: Tracks API calls regardless of variable names or destructuring patterns
- **Handles Vue files**: Extracts `<script>` sections from Vue files for analysis

### 2. Analysis Process

#### Step 1: Install jscodeshift (if not already installed)
```bash
npm install -g jscodeshift
```

#### Step 2: Create the jscodeshift transformer
The transformer (`analyze-all-api-calls.js`) detects:
- Direct API calls: `api().message.fetch()`
- Variable assignments: `const messageStore = useMessageStore(); messageStore.fetch()`
- Destructured calls: `const { fetch } = useMessageStore(); fetch()`
- Store method usage patterns

#### Step 3: Run the parallel analysis script
```bash
./run-parallel-api-analysis.sh
```

This script:
1. Processes all JS files in `iznik-nuxt3` (FD) and `iznik-nuxt3-modtools` (MT)
2. Extracts script sections from Vue files for analysis
3. Runs up to 10 parallel analysis jobs for performance
4. Combines results into comprehensive reports
5. Generates a markdown summary

### 3. Output Files
- Individual results per file (can be deleted after combining)
- Combined JSON for FD and MT
- Final markdown report with statistics and insights

## Running the Analysis

### Quick Run
```bash
# From the FreegleDockerWSL directory
cd plans/scripts
./run-parallel-api-analysis.sh
```

### What Gets Analyzed
- **FD**: All files in `iznik-nuxt3/` excluding node_modules and .nuxt
- **MT**: All files in `iznik-nuxt3-modtools/` excluding node_modules and .nuxt
- **File types**: .js and .vue files

### Expected Runtime
- ~8-10 minutes for full analysis
- Processes ~900+ files total
- Uses parallel processing for efficiency

## Interpreting Results

### Key Metrics
- **Unique endpoints**: Number of different API endpoints used
- **Total calls**: Total number of API call sites in code
- **FD-only**: Endpoints used exclusively by FD
- **MT-only**: Endpoints used exclusively by MT (mainly moderation)
- **Shared**: Endpoints used by both applications

### Important Findings
- Most endpoints are shared between FD and MT
- MT has additional moderation-specific endpoints
- FD has minimal exclusive endpoints (simplifies migration)

## Repeating the Analysis

### When to Re-run
- After significant code changes
- Before major migration phases
- To verify migration progress
- To find remaining v1 API calls

### Steps to Repeat
1. Ensure you're in the FreegleDockerWSL directory
2. Run: `./plans/scripts/run-parallel-api-analysis.sh`
3. Review the generated `comprehensive-api-analysis-final.md`
4. Update migration documentation as needed

## Files in This Directory

### Core Scripts (Keep These)
- `analyze-all-api-calls.js` - jscodeshift transformer for finding API calls
- `run-parallel-api-analysis.sh` - Parallel analysis runner script
- `api-analysis-readme.md` - This documentation

### Temporary Files (Can Delete)
- `*.json` - Intermediate JSON results
- `api-analysis-results/` - Individual file results
- Can be regenerated by running the analysis again

## Troubleshooting

### If jscodeshift is not found
```bash
npm install -g jscodeshift
```

### If script permissions error
```bash
chmod +x run-parallel-api-analysis.sh
```

### If Vue files show errors
- Normal: Some Vue files may have JSX or template syntax that jscodeshift can't parse
- These errors are logged but don't affect the overall analysis

## Next Steps
After running the analysis:
1. Review the comprehensive report
2. Update `plans/v1-api-analysis-and-migration.md` with findings
3. Adjust migration priorities based on actual usage patterns
4. Track progress in `plans/api-migration-todos.md`
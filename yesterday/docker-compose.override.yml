# Docker Compose Override for Yesterday Backup/Restore Environment
#
# PURPOSE:
# This file configures the FreegleDocker stack to work with restored production backups
# on the Yesterday server. It overrides settings from the base docker-compose.yml.
#
# USAGE:
# 1. Yesterday restore script (yesterday/scripts/restore-backup.sh) copies this file
#    to the repository root as docker-compose.override.yml
# 2. Docker Compose automatically merges this with docker-compose.yml when running
# 3. CircleCI explicitly uses '-f docker-compose.yml' to skip this override
#
# KEY DIFFERENCES FROM BASE CONFIG:
# - Uses production image/upload services (images.ilovefreegle.org, tus.ilovefreegle.org)
# - Mounts MySQL config files generated by restore script
# - Sets freegle_db volume as external (restored from backup)
# - Uses production database password from .env
#
# DO NOT EDIT THE ROOT docker-compose.override.yml - IT IS AUTO-GENERATED!
# This file (yesterday/docker-compose.override.yml) is the single source of truth.

services:
  reverse-proxy:
    # Add HTTPS entrypoints for dev/prod containers and APIs with Let's Encrypt
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.api.address=:8192"
      - "--entrypoints.traefik.address=:8080"
      - "--entrypoints.freegle-dev.address=:3002"
      - "--entrypoints.modtools-dev.address=:3003"
      - "--entrypoints.freegle-prod.address=:3012"
      - "--entrypoints.modtools-prod.address=:3013"
      - "--entrypoints.apiv1-ssl.address=:8181"
      - "--entrypoints.apiv2-ssl.address=:8193"
      - "--accesslog=true"
      - "--entrypoints.web.forwardedHeaders.insecure=true"
      - "--certificatesresolvers.letsencrypt.acme.email=geeks@ilovefreegle.org"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=gcloud"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=30"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "8192:8192"
      - "8080:8080"
      - "0.0.0.0:3002:3002"
      - "0.0.0.0:3003:3003"
      - "0.0.0.0:3012:3012"
      - "0.0.0.0:3013:3013"
      - "0.0.0.0:8181:8181"
      - "0.0.0.0:8193:8193"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/traefik/secrets/gcloud-dns-key.json:/secrets/gcloud-dns-key.json:ro
      - ./data/main-letsencrypt:/letsencrypt
    environment:
      - GCE_PROJECT=freegle-1139
      - GCE_SERVICE_ACCOUNT_FILE=/secrets/gcloud-dns-key.json

  delivery:
    # Not used - containers use production delivery service (images.ilovefreegle.org)
    # Container kept for potential local testing
    labels:
      - "traefik.enable=false"

  percona:
    # Mount MySQL server config generated by restore script with InnoDB settings from backup
    # File: ./conf/percona-my.cnf (created during restore process, persists across reboots)
    volumes:
      - ./conf/percona-my.cnf:/etc/my.cnf:ro

  apiv1:
    # Routed through Traefik for SSL termination on port 8181
    # Mount MySQL client config with production database password
    # File: ./iznik-server-my.cnf (created by scripts/generate-mysql-configs.sh)
    ports: !reset []
    volumes:
      - ./iznik-server-my.cnf:/root/.my.cnf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.apiv1-ssl.rule=Host(`yesterday.ilovefreegle.org`)"
      - "traefik.http.routers.apiv1-ssl.entrypoints=apiv1-ssl"
      - "traefik.http.routers.apiv1-ssl.service=apiv1-ssl"
      - "traefik.http.routers.apiv1-ssl.tls.certresolver=letsencrypt"
      - "traefik.http.routers.apiv1-ssl.tls.domains[0].main=yesterday.ilovefreegle.org"
      - "traefik.http.services.apiv1-ssl.loadbalancer.server.port=80"
    # Simplified startup command for Yesterday - skips DB initialization (schema.sql, testenv.php, etc)
    # to preserve restored production data
    command: >
      /bin/sh -c "sed -i \"s/define('SQLPASSWORD', '.*')/define('SQLPASSWORD', '\$$MYSQL_PASSWORD')/\" /etc/iznik.conf &&
      /etc/init.d/ssh start &&
      cp install/nginx.conf /etc/nginx/sites-available/default &&
      /etc/init.d/nginx start &&
      /etc/init.d/cron start &&
      /etc/init.d/php8.1-fpm start &&
      /etc/init.d/postfix start &&
      cd /var/www/iznik &&
      sh -c 'nohup sh -c \"while true; do cd /var/www/iznik/scripts/cron && php ./message_spatial.php >> /tmp/iznik.message_spatial.out 2>&1; sleep 10; done\" </dev/null >/dev/null 2>&1 & exec sleep infinity'"
    environment:
      # Use production image services so restored data displays correctly
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org

  apiv2:
    # Routed through Traefik for SSL termination on port 8193
    ports: !reset []
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.apiv2-ssl.rule=Host(`yesterday.ilovefreegle.org`)"
      - "traefik.http.routers.apiv2-ssl.entrypoints=apiv2-ssl"
      - "traefik.http.routers.apiv2-ssl.service=apiv2-ssl"
      - "traefik.http.routers.apiv2-ssl.tls.certresolver=letsencrypt"
      - "traefik.http.routers.apiv2-ssl.tls.domains[0].main=yesterday.ilovefreegle.org"
      - "traefik.http.services.apiv2-ssl.loadbalancer.server.port=8192"
    # Use production image services
    environment:
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/

  freegle-dev:
    # Routed through Traefik for SSL termination on port 3002
    # No direct port binding - Traefik handles HTTPS and proxies to container
    ports: !reset []
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-dev.rule=Host(`yesterday.ilovefreegle.org`)"
      - "traefik.http.routers.freegle-dev.entrypoints=freegle-dev"
      - "traefik.http.routers.freegle-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.freegle-dev.tls.domains[0].main=yesterday.ilovefreegle.org"
      - "traefik.http.services.freegle-dev.loadbalancer.server.port=3002"
    environment:
      - IZNIK_API_V1=https://yesterday.ilovefreegle.org:8181/api
      - IZNIK_API_V2=https://yesterday.ilovefreegle.org:8193/api
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/
      - IMAGE_BASE_URL=https://uploads.ilovefreegle.org
      - USER_SITE=https://yesterday.ilovefreegle.org:3002

  freegle-prod:
    # DISABLED: We only use dev containers on Yesterday
    # Reason: Dev containers start in seconds, prod containers take 10+ minutes to build
    # Production containers are disabled to save resources and startup time
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.freegle-prod.rule=Host(`yesterday.ilovefreegle.org`)"
      - "traefik.http.routers.freegle-prod.entrypoints=freegle-prod"
      - "traefik.http.routers.freegle-prod.tls.certresolver=letsencrypt"
      - "traefik.http.routers.freegle-prod.tls.domains[0].main=yesterday.ilovefreegle.org"
      - "traefik.http.services.freegle-prod.loadbalancer.server.port=3000"
    environment:
      - USER_SITE=https://yesterday.ilovefreegle.org:3012
    deploy:
      replicas: 0

  modtools-dev:
    # Routed through Traefik for SSL termination on port 3003
    # No direct port binding - Traefik handles HTTPS and proxies to container
    ports: !reset []
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-dev.rule=Host(`yesterday.ilovefreegle.org`)"
      - "traefik.http.routers.modtools-dev.entrypoints=modtools-dev"
      - "traefik.http.routers.modtools-dev.tls.certresolver=letsencrypt"
      - "traefik.http.routers.modtools-dev.tls.domains[0].main=yesterday.ilovefreegle.org"
      - "traefik.http.services.modtools-dev.loadbalancer.server.port=3000"
    environment:
      - IZNIK_API_V1=https://yesterday.ilovefreegle.org:8181/api
      - IZNIK_API_V2=https://yesterday.ilovefreegle.org:8193/api
      - IMAGE_DELIVERY=https://delivery.ilovefreegle.org
      - IMAGE_BASE_URL=http://freegle-freegle-dev:3002
      - TUS_UPLOADER=https://uploads.ilovefreegle.org/
      - USER_SITE=https://yesterday.ilovefreegle.org:3003

  modtools-prod:
    # DISABLED: We only use dev containers on Yesterday
    # Reason: Dev containers start in seconds, prod containers take 10+ minutes to build
    # Production containers are disabled to save resources and startup time
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.modtools-prod.rule=Host(`yesterday.ilovefreegle.org`)"
      - "traefik.http.routers.modtools-prod.entrypoints=modtools-prod"
      - "traefik.http.routers.modtools-prod.tls.certresolver=letsencrypt"
      - "traefik.http.routers.modtools-prod.tls.domains[0].main=yesterday.ilovefreegle.org"
      - "traefik.http.services.modtools-prod.loadbalancer.server.port=3000"
    environment:
      - USER_SITE=https://yesterday.ilovefreegle.org:3013
    deploy:
      replicas: 0

volumes:
  freegle_db:
    # Mark as external - this volume is populated by the restore script
    # with production backup data and should not be recreated by Docker
    external: true

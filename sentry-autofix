#!/usr/bin/env node

/**
 * Sentry Auto-Fix CLI
 *
 * Polls Sentry for high-priority issues and uses Claude Code CLI to automatically
 * create fixes with test cases and PRs.
 *
 * Usage:
 *   ./sentry-autofix --poll              # Poll once for all issues
 *   ./sentry-autofix --poll-one          # Poll once for just one issue and exit
 *   ./sentry-autofix --daemon [minutes]  # Run repeatedly, polling every X minutes (default: 15)
 *   ./sentry-autofix --clear             # Clear processed issues database
 *   ./sentry-autofix --status            # Show status
 *   ./sentry-autofix --help              # Show help
 *
 * Environment variables (from .env):
 *   SENTRY_AUTH_TOKEN      - Sentry API token
 *   SENTRY_ORG_SLUG        - Sentry organization slug (default: freegle)
 *   SENTRY_DB_PATH         - SQLite database path (default: ./sentry-issues.db)
 */

const SentryIntegration = require('./sentry-autofix.js');

// Load environment variables from .env file
require('dotenv').config();

// Parse command line arguments
const args = process.argv.slice(2);
let command = null;
let config = {
  sentryAuthToken: process.env.SENTRY_AUTH_TOKEN,
  sentryOrgSlug: process.env.SENTRY_ORG_SLUG || 'freegle',
  dbPath: process.env.SENTRY_DB_PATH || './sentry-issues.db',
  ignoreAlreadyProcessing: process.env.SENTRY_IGNORE_ALREADY_PROCESSING === 'true',
  maxIssuesPerPoll: process.env.SENTRY_MAX_ISSUES_PER_POLL ? parseInt(process.env.SENTRY_MAX_ISSUES_PER_POLL) : null,
  intervalMinutes: 15,
  prNumber: null,
  projectFilter: null,
};

// Parse command line arguments
for (let i = 0; i < args.length; i++) {
  const arg = args[i];

  if (arg.startsWith('--') || arg.startsWith('-')) {
    // This is a command or option
    if (!command) {
      command = arg;
    } else if (arg === '--token' || arg === '-t') {
      config.sentryAuthToken = args[++i];
    } else if (arg === '--org' || arg === '-o') {
      config.sentryOrgSlug = args[++i];
    } else if (arg === '--db' || arg === '-d') {
      config.dbPath = args[++i];
    } else if (arg === '--ignore-processed') {
      config.ignoreAlreadyProcessing = true;
    } else if (arg === '--max-issues') {
      config.maxIssuesPerPoll = parseInt(args[++i]);
    } else if (arg === '--pr-number') {
      config.prNumber = parseInt(args[++i]);
    } else if (arg === '--project') {
      const projects = args[++i].split(',').map(p => p.trim());
      config.projectFilter = projects;
    }
  } else if (command === '--daemon' && !isNaN(parseInt(arg))) {
    config.intervalMinutes = parseInt(arg);
  }
}

// Handle commands
async function main() {
  // Show help without requiring auth token
  if (command === '--help' || command === '-h' || !command) {
    console.log(`
Sentry Auto-Fix CLI

Polls Sentry for high-priority issues and uses Claude Code CLI to automatically
create fixes with test cases and PRs.

Usage:
  ./sentry-autofix --poll [options]            Poll once for all high-priority issues
  ./sentry-autofix --poll-one [options]        Poll once for just one issue and exit
  ./sentry-autofix --daemon [minutes] [opts]   Run repeatedly every X minutes (default: 15)
  ./sentry-autofix --monitor-prs [options]     Monitor open PRs for comments and test failures
  ./sentry-autofix --clear                     Clear processed issues database
  ./sentry-autofix --status [options]          Show current status
  ./sentry-autofix --help                      Show this help message

Options:
  --token, -t <token>          Sentry API auth token (or use SENTRY_AUTH_TOKEN env var)
  --org, -o <slug>             Sentry organization slug (default: freegle)
  --db <path>                  SQLite database path (default: ./sentry-issues.db)
  --ignore-processed           Bypass duplicate check (process issues again)
  --max-issues <n>             Limit number of issues to process per poll
  --pr-number <n>              Filter to specific PR number (for --monitor-prs)
  --project <name[,name...]>   Filter to specific project(s) (e.g., php, go, nuxt3)

Examples:
  ./sentry-autofix --poll-one --token sntryu_xxx
  ./sentry-autofix --daemon 30 --org my-org --max-issues 5
  ./sentry-autofix --poll --ignore-processed
  ./sentry-autofix --poll --project php
  ./sentry-autofix --poll --project php,go
  ./sentry-autofix --monitor-prs --project nuxt3
  ./sentry-autofix --status
    `);
    return;
  }

  // Validate required configuration for non-help commands
  if (!config.sentryAuthToken) {
    console.error('Error: Sentry auth token is required');
    console.error('Provide it via --token argument or SENTRY_AUTH_TOKEN environment variable');
    process.exit(1);
  }

  // Initialize Sentry Integration
  const sentryIntegration = new SentryIntegration({
    sentryOrgSlug: config.sentryOrgSlug,
    sentryAuthToken: config.sentryAuthToken,
    pollIntervalMs: 900000, // Not used in CLI mode
    ignoreAlreadyProcessing: config.ignoreAlreadyProcessing,
    maxIssuesPerPoll: config.maxIssuesPerPoll,
    prNumber: config.prNumber,
    projectFilter: config.projectFilter,
  });
  switch (command) {
    case '--poll':
    case '-p':
      console.log('Polling Sentry for all issues...');
      await sentryIntegration.pollSentryIssues();
      console.log('Done!');
      break;

    case '--poll-one':
      console.log('Polling Sentry for one issue...');
      // Create a temporary instance with maxIssuesPerPoll=1
      const oneIssueIntegration = new SentryIntegration({
        sentryOrgSlug: config.sentryOrgSlug,
        sentryAuthToken: config.sentryAuthToken,
        maxIssuesPerPoll: 1,
        ignoreAlreadyProcessing: config.ignoreAlreadyProcessing,
      });
      await oneIssueIntegration.pollSentryIssues();
      console.log('Done!');
      break;

    case '--daemon':
      const intervalMs = config.intervalMinutes * 60 * 1000;
      console.log(`Starting daemon mode - polling every ${config.intervalMinutes} minutes`);
      console.log('Press Ctrl+C to stop');

      // Run immediately on start
      await sentryIntegration.pollSentryIssues();

      // Then run on interval
      setInterval(async () => {
        console.log(`\\n--- Polling Sentry (${new Date().toISOString()}) ---`);
        await sentryIntegration.pollSentryIssues();
      }, intervalMs);

      // Keep process running
      await new Promise(() => {});
      break;

    case '--clear':
    case '-c':
      console.log('Clearing processed issues database...');
      sentryIntegration.clearProcessedIssues();
      console.log('Done!');
      break;

    case '--status':
    case '-s':
      const status = sentryIntegration.getStatus();
      console.log('Sentry Auto-Fix Status:');
      console.log(JSON.stringify(status, null, 2));
      break;

    case '--monitor-prs':
      console.log('Monitoring open PRs for comments and test failures...');
      await sentryIntegration.monitorPRs();
      console.log('Done!');
      break;

    default:
      console.error(`Unknown command: ${command}`);
      console.error('Run ./sentry-autofix --help for usage information');
      process.exit(1);
  }
}

main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});

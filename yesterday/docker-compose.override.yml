# Docker Compose Override for Yesterday Backup/Restore Environment
#
# PURPOSE:
# This file configures the FreegleDocker stack to work with restored production backups
# on the Yesterday server. It overrides settings from the base docker-compose.yml.
#
# USAGE:
# 1. Yesterday restore script (yesterday/scripts/restore-backup.sh) copies this file
#    to the repository root as docker-compose.override.yml
# 2. Docker Compose automatically merges this with docker-compose.yml when running
# 3. CircleCI explicitly uses '-f docker-compose.yml' to skip this override
#
# KEY DIFFERENCES FROM BASE CONFIG:
# - Uses production image/upload services (images.ilovefreegle.org, tus.ilovefreegle.org)
# - Mounts MySQL config files generated by restore script
# - Sets freegle_db volume as external (restored from backup)
# - Uses production database password from .env
#
# DO NOT EDIT THE ROOT docker-compose.override.yml - IT IS AUTO-GENERATED!
# This file (yesterday/docker-compose.override.yml) is the single source of truth.

services:
  percona:
    # Mount MySQL server config generated by restore script with InnoDB settings from backup
    # File: /tmp/percona-my.cnf (created during restore process)
    volumes:
      - /tmp/percona-my.cnf:/etc/my.cnf:ro

  apiv1:
    # Mount MySQL client config with production database password
    # File: ./iznik-server-my.cnf (created by scripts/generate-mysql-configs.sh)
    volumes:
      - ./iznik-server-my.cnf:/root/.my.cnf:ro
    environment:
      # Use production image services so restored data displays correctly
      - TUS_UPLOADER=https://tus.ilovefreegle.org/tus/
      - IMAGE_DELIVERY=https://images.ilovefreegle.org

  apiv2:
    # Use production image services
    environment:
      - IMAGE_DELIVERY=https://images.ilovefreegle.org
      - TUS_UPLOADER=https://tus.ilovefreegle.org/tus/

  freegle-dev:
    # Use production image services for restored user-uploaded images
    environment:
      - IMAGE_DELIVERY=https://images.ilovefreegle.org
      - TUS_UPLOADER=https://tus.ilovefreegle.org/tus/
      - IMAGE_BASE_URL=https://tus.ilovefreegle.org/tus

  freegle-prod:
    # Use production image services for restored user-uploaded images
    environment:
      - IMAGE_DELIVERY=https://images.ilovefreegle.org
      - TUS_UPLOADER=https://tus.ilovefreegle.org/tus/
      - IMAGE_BASE_URL=https://tus.ilovefreegle.org/tus

  modtools-dev:
    # Use production image services for restored user-uploaded images
    environment:
      - IMAGE_DELIVERY=https://images.ilovefreegle.org
      - TUS_UPLOADER=https://tus.ilovefreegle.org/tus/
      - IMAGE_BASE_URL=https://tus.ilovefreegle.org/tus

  modtools-prod:
    # Use production image services for restored user-uploaded images
    environment:
      - IMAGE_DELIVERY=https://images.ilovefreegle.org
      - TUS_UPLOADER=https://tus.ilovefreegle.org/tus/
      - IMAGE_BASE_URL=https://tus.ilovefreegle.org/tus

volumes:
  freegle_db:
    # Mark as external - this volume is populated by the restore script
    # with production backup data and should not be recreated by Docker
    external: true

global
  log 127.0.0.1 local0
  maxconn 100000
  daemon
  uid 99
  gid 99
  lua-load /etc/haproxy/lua/rate_delay.lua
  tune.lua.maxmem 64

defaults
  log     global
  timeout connect 5000
  timeout client 50000
  timeout server 50000
  maxconn 100000
  fullconn 100000

frontend http_frontend
  bind *:80
  mode http

  # Check for LetsEncrypt challenge
  acl path_certbot path_beg /.well-known/acme-challenge/

  # Redirect http to https unless it's certbot
  http-request redirect scheme https unless { ssl_fc } || path_certbot

  # Use the built-in web server to serve the certbot challenge
  use_backend letsencrypt-backend if path_certbot

frontend https_frontend
  mode http

  bind *:443 ssl crt-list /etc/haproxy/haproxy.crtlist

  # Define ACLs early so we can use them for rate limit exemptions.
  acl new_modtools hdr(host) -i modtools.org
  acl new_modtools hdr(host) -i new.modtools.org
  acl api_path path_beg -i /api
  acl api_host hdr(host) -i api.ilovefreegle.org
  acl is_api_request api_path or api_host

  # Rate limit based on IP with graduated delays.
  # Stick table tracks requests per second per IP.
  # Only track API requests - static assets don't need rate limiting.
  stick-table type ip size 100k expire 1m store http_req_rate(1s),conn_cur
  http-request track-sc0 src if is_api_request

  # Calculate delay based on rate (Lua script).
  # Delays: 0ms at <=5 req/s, scaling to 2000ms at 20+ req/s.
  http-request lua.rate_check if is_api_request

  # Hard reject only at extreme rates (safety valve).
  # Only applies to API requests - static assets are exempt.
  http-request deny deny_status 429 if is_api_request { sc_http_req_rate(0) gt 50 }

  # ModTools is now on Netlify, as a branch deployment of the ILF site.  We can't manage to get certificates working on there,
  # but we can proxy to it from here.
  use_backend modtools_netlify_backend if new_modtools !api_path
  # The next two lines are redirects we were using before the proxy was working.
  #http-request redirect code 302 location https://modtools--golden-caramel-d2c3a7.netlify.app%[capture.req.uri] if new_modtools !api_path
  #http-request redirect code 302 location https://fdapilive.ilovefreegle.org/api%[capture.req.uri] if new_modtools api_path
  # ...end redirects

  # The uploader requires a different backend and headers, so spot if we're accessing that.
  #
  # If also doesn't work unless we disable http-buffer-request
  acl uploader hdr(host) -i uploads.ilovefreegle.org
  use_backend tusd_backend if uploader
  no option http-buffer-request

  # Redirect any requests to the API to the API backend.  This allows us to access the API over port 443 as well as 8192, which helps
  # in some firewall scenarios.
  acl api_request hdr(host) -i api.ilovefreegle.org
  use_backend api_server_backend if api_request

  # Uploadcare image proxy
  acl uploadcare_cache hdr(host) -i uploadcare-cache.ilovefreegle.org
  use_backend http_backend_cache if uploadcare_cache
  acl uploadcare_proxy_cache hdr(host) -i uploadcare-proxy-cache.ilovefreegle.org
  use_backend http_backend_cache if uploadcare_proxy_cache

  acl delivery hdr(host) -i delivery.ilovefreegle.org
  use_backend http_backend_cache if delivery

  # Backend web servers are accessed over http, so that SSL termination/renewal happens on this server.
  default_backend http_backend

backend http_backend
  mode http
  balance leastconn
  stick-table type ip size 200k expire 30m
  stick on src
  option redispatch

  # Apply graduated delay on response for heavy users.
  http-response lua.rate_delay

  server app1 10.220.0.45:80 send-proxy check
  server app4 10.220.0.188:80 send-proxy check
  http-response del-header Access-Control-Allow-Origin
  http-response set-header Access-Control-Allow-Origin "*"

# Use one server preferentially because that increases cache hits while preserving resilience.
backend http_backend_cache
  mode http
  balance leastconn
  stick-table type ip size 200k expire 30m
  stick on src
  option redispatch
  server app1 10.220.0.45:80 send-proxy check
  server app4 10.220.0.188:80 send-proxy check backup

frontend api_server_frontend
  bind *:8192 ssl crt /etc/haproxy/api.ilovefreegle.org.pem

  # Rate limit based on IP with graduated delays.
  stick-table type ip size 100k expire 1m store http_req_rate(1s),conn_cur
  http-request track-sc0 src
  http-request lua.rate_check
  http-request deny deny_status 429 if { sc_http_req_rate(0) gt 50 }

  # Check for LetsEncrypt challenge
  acl letsencrypt-acl path_beg /.well-known/acme-challenge/
  use_backend letsencrypt-backend if letsencrypt-acl

  # Otherwise...
  default_backend api_server_backend

backend api_server_backend
  mode http
  balance leastconn
  stick-table type ip size 200k expire 30m
  stick on src
  option redispatch

  # Apply graduated delay on response for heavy users.
  http-response lua.rate_delay

  server db1-katapult 185.199.222.206:8192 check backup
  server db2-katapult 185.199.222.59:8192 check backup
  server db3-katapult 185.199.222.20:8192 check

frontend tusd_frontend
  bind *:8080 ssl crt /etc/haproxy/uploads.ilovefreegle.org.pem
  redirect scheme https if !{ ssl_fc }
  mode http
  no option http-buffer-request

  default_backend tusd_backend

backend tusd_backend
  mode http
  balance leastconn
  no option http-buffer-request
  stick-table type ip size 200k expire 30m
  stick on src
  option redispatch
  http-request set-header X-Forwarded-Proto "https"
  http-request add-header X-Forwarded-For %[src]
  http-response add-header Access-Control-Allow-Origin *
  http-response add-header Access-Control-Allow-Headers 'Authorization, Origin, X-Requested-With, X-Request-ID, X-HTTP-Method-Override, Content-Type, Upload-Length, Upload-Offset, Tus-Resumable, Upload-Metadata, Upload-Defer-Length, Upload-Concat, Upload-Complete, Upload-Draft-Interop-Version, x-token, baggage, sentry-trace'
  http-response add-header Access-Control-Allow-Methods 'POST, HEAD, PATCH, OPTIONS, GET, DELETE'
  http-response add-header Access-Control-Expose-Headers 'Location,Upload-Offset,Upload-Length'
  server app1 10.220.0.45:8080 check
  server app4 10.220.0.188:8080 check backup

# LetsEncrypt backend for certbot renewal
backend letsencrypt-backend
  mode http
  server letsencrypt 127.0.0.1:8888

backend modtools_netlify_backend
  mode http
  http-request set-header Host modtools--golden-caramel-d2c3a7.netlify.app
  server netlify modtools--golden-caramel-d2c3a7.netlify.app:443 ssl verify none

listen stats
  bind :1936
  mode http
  stats enable
  stats hide-version
  stats realm Haproxy\ Statistics
  stats uri /
  stats auth statsigle:GRFE24325hgfklytr
